<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>웹브라우저만으로 mp4 파일 재생</title>
    <style>
        .hidden {
            display: none;
        }
    </style>

</head>

<body>
    <h1>웹브라우저만으로 mp4 파일 재생</h1>
    <section>
        <video id="video" controls width="600"></video>
    </section>
    <section>
        <!-- 버튼을 추가하고 버튼을 눌렀을 때 mp4 파일을 선택할 수 있는 파일 다이얼로그를 띄운다.-->
        <button id="openFileBtn">MP4 파일 선택</button>
        <input type="file" id="fileInput" accept="video/mp4" class="hidden" />
    </section>
    <script>const video = document.getElementById('video');
        const openFileBtn = document.getElementById('openFileBtn');
        const fileInput = document.getElementById('fileInput');

        openFileBtn.addEventListener('click', () => {
            fileInput.click();
        });

        fileInput.addEventListener('change', (event) => {
            const file = event.target.files && event.target.files[0];
            if (!file) return;

            if (!file.type || !file.type.startsWith('video/mp4')) {
                // mp4가 아니면 직접 URL로 재생 시도
                video.src = URL.createObjectURL(file);

                video.play().catch(() => { });
                return;
            }

            const codecs = 'video/mp4; codecs="avc1.42E01E, mp4a.40.2"';

            if (window.MediaSource && MediaSource.isTypeSupported(codecs)) {
                try {
                    const mediaSource = new MediaSource();
                    video.src = URL.createObjectURL(mediaSource);

                    mediaSource.addEventListener('sourceopen', async () => {
                        const sourceBuffer = mediaSource.addSourceBuffer(codecs);

                        const arrayBuffer = await file.arrayBuffer();

                        sourceBuffer.addEventListener('error', (e) => {
                            console.error('SourceBuffer error:', e);
                            // SourceBuffer 사용 중 오류가 발생하면 직접 URL로 재생 시도
                            URL.revokeObjectURL(video.src);
                            video.src = URL.createObjectURL(file);

                            video.play().catch(() => { });
                        }

                            , {
                                once: true
                            });

                        sourceBuffer.addEventListener('updateend', () => {
                            try {
                                if (mediaSource.readyState === 'open') {
                                    mediaSource.endOfStream();
                                }

                                video.play().catch(() => { });
                            }

                            catch (e) {
                                console.error('Error during endOfStream or play:', e);
                            }
                        }

                            , {
                                once: true
                            });

                        try {
                            sourceBuffer.appendBuffer(arrayBuffer);
                        }

                        catch (e) {
                            console.error('Error appending buffer:', e);
                            // appendBuffer 중 오류가 발생하면 직접 URL로 재생 시도
                            URL.revokeObjectURL(video.src);
                            video.src = URL.createObjectURL(file);

                            video.play().catch(() => { });
                        }
                    }

                        , {
                            once: true
                        });
                }

                catch (e) {
                    console.error('MediaSource error:', e);
                    // MediaSource 사용 중 오류가 발생하면 직접 URL로 재생 시도
                    video.src = URL.createObjectURL(file);

                    video.play().catch(() => { });
                }
            }

            else {
                // MediaSource가 지원되지 않으면 직접 URL로 재생 시도
                video.src = URL.createObjectURL(file);

                video.play().catch(() => { });
            }
        });
    </script>
</body>

</html>